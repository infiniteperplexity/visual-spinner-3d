<!--Distributed under GNU Public License version 3-->
<!DOCTYPE html>
<html><head>
<style>
body {margin: 0; padding: 0; background-color: #679}
h1, h2, header p {text-align: center}
header a {position: absolute; top: 5px; left: 5px}
header {width: 1240px; height: 100px}
#content {width: 1250px; height: 510px;}
section {margin: 0; padding: 0}
header, section div {vertical-align: top; padding: 2.5px; border: 5px solid gray; margin: -2.5px; display: inline-block;}
#display {width: 400px; height: 400px; float: left}
#control {position: absolute; top: 550px; left: 0; height: 65px; width: 400px; border-top-width: 0px}
#queues {width: 410px; height: 500px; float: left}
.queue {padding-top: 0; width: 200px; height: 206px; border: 0; float: left}
#queue1, #queue3 {padding-right: 12px}
#queue1, #queue2 {padding-bottom: 25px}
.queue ul {width: 190px; height: 165px}
#menu, #workshop {width: 200px; height: 500px; float: left}
canvas {width: 400px; height: 400px; background-color: #000;}
ul {background-color: #FFF;  list-style-type: none; padding-left: 0; overflow-y: scroll; overflow-x: hidden;}
li {font-size: 90%;}
li:hover {background-color: lightcyan; cursor: grab;}
.active {background-color: mediumaquamarine;}
#queues h2, #menu h2, #workshop h2 {height: 25px; text-decoration: underline}
#queues h2 {text-align: left; text-indent: 5px}
#menu ul {width: 200px; height: 430px;}
#workshop ul {width: 199px; height: 380px;}
table {position: relative; top: -20px;}
#popexport, #popimport, #popsave, #popload {position: fixed; z-index: 1; top: 150px; left: 50px; }
#popalign1 {position: fixed; z-index: 1; top: 100px; left: 420px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#popalign2 {position: fixed; z-index: 1; top: 100px; left: 630px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#popalign3 {position: fixed; z-index: 1; top: 300px; left: 420px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#popalign4 {position: fixed; z-index: 1; top: 300px; left: 630px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#radius1, #radius2 {width: 50px;}
#frameN {width: 100px;}
#moveview {position: fixed; z-index: 1; top: 150px; left: 250px; width: 400px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#movemodify {position: fixed; z-index: 1; top: 150px; left: 550px; width: 400px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
#jsonmodify {position: fixed; z-index: 1; top: 150px; left: 550px; width: 400px; background-color: #FFF; padding: 2.5px; border: 5px solid gray; margin: -2.5px;}
</style>


<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>VisualSpinner3D Composer, by Glenn Wright</title>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="scripts/visual-spinner-engine.js"></script>
<script src="scripts/visual-spinner-moves.js"></script>
<script src="scripts/visual-spinner-ui.js"></script>

<script>
"use strict";
var nearly = VS3D.Utilities.nearly;
var unwind = VS3D.Utilities.unwind;
var moves = VS3D.MoveFactory();
var predictions;

var vs;
var recipes;
var propOne;
var propTwo;
var propThree;
var propFour;

function canvasSetup() {
	vs = VS3D.VisualSpinnerWidget();
	vs.embedById("display");
	vs.addControls("play","pause","rewind","frame","forward","reset","2d3d");
	window.addEventListener("keydown", listenForKey, false);
	predictions = [vs.addProp(),vs.addProp(),vs.addProp(),vs.addProp()];

	predictions[0].color = "0,32,64";
	predictions[1].color = "64,0,0";
	predictions[0].dummy = true;
	predictions[1].dummy = true;
	predictions[2].color = "0,64,0";
	predictions[3].color = "64,64,0";
	predictions[2].dummy = true;
	predictions[3].dummy = true;


	propOne = vs.addProp();
	propOne.color = "blue";
	propTwo = vs.addProp();
	propTwo.color = "red";
	// set up props
	propOne.hand.radius = 1;
	propTwo.hand.radius = 1;
	propOne.rotateHand(vs.SPLIT);
	propOne.rotateProp(vs.SPLIT);
	propThree = vs.addProp();
	propThree.color = "green";
	propThree.propType = "noprop";
	predictions[2].propType = "noprop";
	propFour = vs.addProp();
	propFour.color = "yellow";
	propFour.propType = "noprop";
	predictions[3].propType = "noprop";
	// set up props
	propThree.hand.radius = 1;
	propFour.hand.radius = 1;
	propThree.rotateHand(vs.SPLIT);
	propThree.rotateProp(vs.SPLIT);

	predict();
	vs.ready();
}
window.addEventListener("keydown", listenForKey, false);


VS3D.overrideReorientFail(function() {return});



function redraw() {
	vs.renderer.render(vs.scene);
}

//**** on load
function init() {
	$("#popexport").hide();
	$("#popimport").hide();
	parseRecipes("composer-recipes.json");
	canvasSetup();
}

function parseRecipes(url) {
	$.ajax({
		url: url,
		type: "GET",
		dataType: "text",
		cache: false,
		success: function(data) {populateMenu(data);}
	});
}

function populateMenu(json) {
	var menu = $("#menu").children("ul");
	var option;
	menu.empty();
	recipes = JSON.parse(json);
	var options;
	var augmented;
	var defaults;
	for (var key in recipes.recipes) {
		if (key !== "add") {
			option = '<li draggable="true" ondragstart="dragMenu(event)" data-value="'+key+'">'+key+"</li>";
			menu.append(option);
		}
		augmented = {};
		options =recipes.recipes[key];
		for (var option in options) {
			augmented[option] = options[option];
		}
		defaults = VS3D.Constants.parse(moves.constructor.prototype.recipes[options.recipe].defaults);
		for (var def in defaults) {
			if (augmented[def] === undefined) {
				augmented[def] = defaults[def];
			}
		}
		if (moves.constructor.prototype.recipes[options.recipe].main) {
			defaults = VS3D.Constants.parse(moves.constructor.prototype.recipes[moves.constructor.prototype.recipes[options.recipe].main].defaults);
			for (var def in defaults) {
				if (augmented[def] === undefined) {
					augmented[def] = defaults[def];
				}
			}
		}
		augmented.name = key;
		recipes.recipes[key] = augmented;
	}
}



//**** handle custom list-item selection
function selectItem(event) {
	$(".active").removeClass("active");
	event.target.setAttribute("class","active");
}

//**** handle drag and drop events
function allowDrop(event) {
	event.preventDefault();
}
function dragMenu(event) {
	var movename = event.target.innerHTML;
	//we probably want to make a helper method that "augments" recipes...
	event.dataTransfer.setData("Text", JSON.stringify(recipes.recipes[movename]));

}
function dropQueue(event) {
	event.preventDefault();
	var definition = event.dataTransfer.getData("Text");
	addMoveToQueue(definition, event.target);
}
function addMoveToQueue(definition, target) {
	totalReset()
	var parsed = JSON.parse(definition);
	parsed.plane = VS3D.Vector(parsed.plane.x,parsed.plane.y,parsed.plane.z);
	var move = moves.build[parsed.recipe](parsed);
	var prop;
	var queue = target.parentNode.id;
	if (queue === "queue1") {
		prop = propOne;
	} else if (queue === "queue2") {
		prop = propTwo;
	} else if (queue === "queue3") {
		prop = propThree;
	} else if (queue === "queue4") {
		prop = propFour;
	}
	var oriented = move.reorient(prop);
	var proceed = true;
	if (oriented === null) {
		proceed = confirm("The engine believes this move cannot be smoothly attached to the end of the current move sequence.  Do you wish to add it anyway?");
		if (proceed === true) {
			oriented = move.setAbrupt();
		}
	}
	if (proceed !== false) {
		var child = document.createElement("li");
		child.innerHTML = JSON.parse(definition).name;
		child.setAttribute("data-value",definition);
		child.addEventListener('dblclick', viewMove);
		child.addEventListener('click', selectItem);
		target.appendChild(child);
		prop.addMove(oriented);
		predict();
	} else {
		alert("Move not added.");

	}
	predict();
	vs.ready();
	redraw();
}

function dragWorkshop(event) {
	$(".active").removeClass("active");
	event.target.setAttribute("class","active");
	var definition = event.target.getAttribute("data-value");
	event.dataTransfer.setData("Text", definition);
}
function dropWorkshop(event) {
	event.preventDefault();
	var target = event.target;
	if (target.parentNode != null && target.parentNode.id === "thisMove") {target = target.parentNode;}
	var child = document.createElement("li");
	child.setAttribute("data-value",event.dataTransfer.getData("Text"));
	child.innerHTML = JSON.parse(child.getAttribute("data-value")).name;
	child.draggable = true;
	child.addEventListener('dragstart',dragWorkshop);
	child.addEventListener('dragover', allowDrop);
	child.addEventListener('dblclick', modifyMove);
	child.addEventListener('click', selectItem);
	target.appendChild(child);
}

//**** placeholder functionality
function nothing() {
	alert("not yet implemented");
}

var moveTarget;

function modifyJSON() {
	alert("not yet implemented");
	return;
	var active = $(".active").get(0);
	if (active===undefined) {
		alert("Please select a move in the workshop."); return;
	}
	var parent = active.parentNode;
	var definition;
	if (parent.parentNode.id === "workshop") {
		definition = moves.parse(active.getAttribute("data-value"));
		moveTarget = active;
	} else {alert("Please select a move in the workshop."); return;}
	$("#jsonmodify").toggle();
	if (definition.modify === undefined) {
		definition.modify = {};
	}
	if (definition.modify_tail === undefined) {
		definition.modify_tail = {};
	}
	$("#jsonmodify textarea").html(JSON.stringify(definition,undefined,2));
}

function submitJSON() {
	var move = moveTarget;
	var definition = $("#jsonmodify textarea").val();
	move.setAttribute("data-value",definition);
	move.innerHTML = JSON.parse(definition).name;
	$("#jsonmodify").toggle();
}

function modifyMove(event) {
	moveTarget = event.target;
	$("#moveinner").empty();
	$("#movemodify").toggle();
	//var definition = moves.parse(event.target.getAttribute("data-value"));
	var definition = JSON.parse(event.target.getAttribute("data-value"));
	var which = "moveinner";
	addInput(which,textInput(definition,"name"));
	addInput(which,textInput(definition,"build"));
	addInput(which,selectInput(definition,"direction",["Clockwise","Counter"],[vs.CLOCKWISE, vs.COUNTERCLOCKWISE]));
	addInput(which,selectInput(definition,"orient",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"entry",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"hand",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"spin",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"spin1",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"spin2",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"bend",["None","Iso-Bend","Anti-Bend","Pro-Bend"],[vs.NOBEND, vs.ISOBEND, vs.ANTIBEND, vs.PROBEND]));
	addInput(which,selectInput(definition,"pitch",["Forward","Backward"],[vs.FORWARD, vs.BACKWARD]));
	addInput(which,selectInput(definition,"rescale",["Inward","Outward"],[-1, 1]));
	addInput(which,selectInput(definition,"petals",["R-Type","Zero","One", "Two", "Three", "Four"],[-1,0,1,2,3,4]));
	addInput(which,selectInput(definition,"petals1",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,selectInput(definition,"petals2",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,selectInput(definition,"harmonics",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,numberInput(definition,"extend",[0,1,0.5]));
	addInput(which,selectInput(definition,"mode",["Diamond","Box","Drag","Follow"],[vs.DIAMOND, vs.BOX, vs.DRAG, vs.FOLLOW]));
	addInput(which,selectInput(definition,"offset",["Offset","No Offset"],[vs.OFFSET, vs.NOOFFSET]));
	addInput(which,numberInput(definition,"duration",[0.25,2,0.25]));
	addInput(which,selectInput(definition,"pivot_angle",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,numberInput(definition,"pivot_radius",[0,1.5,0.5]));
	addInput(which,vectorInput(definition,"plane",["Wall","Wheel","Floor"],[vs.WALL, vs.WHEEL, vs.FLOOR]));
	addInput(which,selectInput(definition,"helper_angle",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,numberInput(definition,"helper_radius",[0,1,0.5]));
	addInput(which,numberInput(definition,"lift",[0,0.5,0.5]));
	addInput(which,numberInput(definition,"swing",[0.5,1,0.25]));
	addInput(which,selectInput(definition,"hybrid",["Pendulum-y","Flower-y"],[true, false]));
	addInput(which,numberInput(definition,"height",[0,3,0.5]));
	addInput(which,numberInput(definition,"drift",[-2,2,0.5]));
	addInput(which,numberInput(definition,"weight",[0,1,0.5]));
}

function viewMove(event) {
	moveTarget = event.target;
	$("#viewinner").empty();
	$("#moveview").toggle();
	var definition = JSON.parse(event.target.getAttribute("data-value"));
	var which = "viewinner";
	addInput(which,textInput(definition,"name"));
	addInput(which,textInput(definition,"build"));
	addInput(which,selectInput(definition,"direction",["Clockwise","Counter"],[vs.CLOCKWISE, vs.COUNTERCLOCKWISE]));
	addInput(which,selectInput(definition,"orient",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"entry",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"hand",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,selectInput(definition,"spin1",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"spin2",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"spin",["In-Spin","Anti-Spin"],[vs.INSPIN, vs.ANTISPIN]));
	addInput(which,selectInput(definition,"bend",["None","Iso-Bend","Anti-Bend","Pro-Bend"],[vs.NOBEND, vs.ISOBEND, vs.ANTIBEND, vs.PROBEND]));
	addInput(which,selectInput(definition,"pitch",["Forward","Backward"],[vs.FORWARD, vs.BACKWARD]));
	addInput(which,selectInput(definition,"stretch",["Inward","Outward"],[-1, 1]));
	addInput(which,selectInput(definition,"petals",["R-Type","Zero","One", "Two", "Three", "Four"],[-1,0,1,2,3,4]));
	addInput(which,selectInput(definition,"petals1",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,selectInput(definition,"petals2",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,selectInput(definition,"harmonics",["Zero","One", "Two", "Three", "Four"],[0,1,2,3,4]));
	addInput(which,numberInput(definition,"extend",[0,1,0.5]));
	addInput(which,selectInput(definition,"mode",["Diamond","Box","Drag","Follow"],[vs.DIAMOND, vs.BOX, vs.DRAG, vs.FOLLOW]));
	addInput(which,selectInput(definition,"offset",["Offset","No Offset"],[vs.OFFSET, vs.NOOFFSET]));
	addInput(which,numberInput(definition,"duration",[0.25,2,0.25]));
	addInput(which,selectInput(definition,"pivot_angle",["Up","Right","Down","Left"],[vs.TWELVE, vs.THREE, vs.SIX, vs.NINE]));
	addInput(which,numberInput(definition,"pivot_radius",[0,1.5,0.5]));
	addInput(which,vectorInput(definition,"plane",["Wall","Wheel","Floor"],[vs.WALL, vs.WHEEL, vs.FLOOR]));
	addInput(which,numberInput(definition,"lift",[0,0.5,0.5]));
	addInput(which,numberInput(definition,"swing",[0.5,1,0.25]));
	addInput(which,selectInput(definition,"hybrid",["Pendulum-y","Flower-y"],[true, false]));
	addInput(which,numberInput(definition,"height",[0,3,0.5]));
	addInput(which,numberInput(definition,"drift",[-2,2,0.5]));
	addInput(which,numberInput(definition,"weight",[0,1,0.5]));
}

function addInput(trgt,inpt) {
	if (inpt === null) {return;}
	if (trgt==="viewinner") {
		inpt.setAttribute("disabled",true);
	}
	var popup = document.getElementById(trgt);
	var txt = document.createElement("span");
	txt.innerHTML = inpt.getAttribute("data-param")+": ";
	popup.appendChild(document.createElement("br"));
	popup.appendChild(txt);
	popup.appendChild(inpt);
}
function textInput(definition, parameter) {
	if (definition[parameter]===undefined) {return null;}
	var inpt = document.createElement("input");
	inpt.type = "text";
	inpt.value = definition[parameter];
	inpt.setAttribute("data-param",parameter);
	return inpt;
}
function numberInput(definition, parameter, arr) {
	if (definition[parameter]===undefined) {return null;}
	var inpt = document.createElement("input");
	inpt.type = "number";
	inpt.min = arr[0].toString();
	inpt.max = arr[1].toString();
	inpt.step = arr[2].toString();
	inpt.value = definition[parameter].toString();
	inpt.setAttribute("data-param",parameter);
	return inpt;
}
function selectInput(definition, parameter, arr, vals) {
	if (definition[parameter]===undefined) {return null;}
	var inpt = document.createElement("select");
	var optn;
	for (var i = 0; i< arr.length; i++) {
		optn = document.createElement("option");
		optn.text = arr[i];
		optn.value = vals[i].toString();
		if (nearly(definition[parameter],vals[i])) {
			optn.selected = true;
		}
		inpt.appendChild(optn);
	}
	inpt.setAttribute("data-param",parameter);
	return inpt;
}

function vectorInput(definition, parameter, arr, vals) {
	if (definition[parameter]===undefined) {return null;}
	var inpt = document.createElement("select");
	var optn;
	for (var i = 0; i< arr.length; i++) {
		optn = document.createElement("option");
		optn.text = arr[i];
		optn.value = JSON.stringify(vals[i]);
		if (vals[i].nearly(definition.plane)) {
			optn.selected = true;
		}
		inpt.appendChild(optn);
	}
	inpt.setAttribute("data-param",parameter);
	return inpt;
}


function isNumber(n) {
	return !isNaN(parseFloat(n)) && isFinite(n);
}
function submitChanges() {
	var move = moveTarget;
	var olddef = JSON.parse(move.getAttribute("data-value"));
	var newdef = {};
	var inputs = $("#moveinner").children().toArray();
	var prmtr;
	var val;
	for (var i = 0; i < inputs.length; i++) {
		if (inputs[i] instanceof HTMLInputElement || inputs[i] instanceof HTMLSelectElement) {
			prmtr = inputs[i].getAttribute("data-param");
			if (prmtr === "plane") {
				val = JSON.parse(inputs[i].value);
				newdef[prmtr] = VS3D.Vector(val.x, val.y, val.z);
			} else {
				newdef[prmtr] = inputs[i].value;
				if (isNumber(newdef[prmtr])) {
					newdef[prmtr] = parseFloat(newdef[prmtr]);
				}
			}
		}
	}
	for (var p in newdef) {
		olddef[p] = newdef[p];
	}
	move.setAttribute("data-value",JSON.stringify(olddef));
	move.innerHTML = olddef.name;
	$("#movemodify").toggle();
}

function totalReset() {
	vs.reset();
	predict();
	redraw();
}

function predict() {
	predictions[0].orientToProp(propOne.predict());
	predictions[1].orientToProp(propTwo.predict());
	predictions[2].orientToProp(propThree.predict());
	predictions[3].orientToProp(propFour.predict());
	predictions[0].nudge(-0.1,0,-0.1);
	predictions[1].nudge(-0.1,0,-0.1);
	predictions[2].nudge(-0.1,0,-0.1);
	predictions[3].nudge(-0.1,0,-0.1);
}
function listenForKey(e) {
	//alert(e.keyCode);
	if (e.keyCode===37) {
		vs.rewind(-12);
	} else if (e.keyCode===39) {
		vs.forward(12);
	} else if (e.keyCode==8 || e.keyCode == 46) {
		deleteItem();
	}
}

function deleteItem() {
	var active = $(".active").get(0);
	var parent = active.parentNode;
	if (parent.parentNode.id === "workshop") {
		parent.removeChild(active);
	} else if (parent.parentNode.className === "queue") {
		parent.removeChild(parent.lastChild);
		if (parent.parentNode.id === "queue1" && propOne.move.submoves.length > 0) {
			propOne.move.submoves.pop();
		} else if (parent.parentNode.id === "queue2" && propTwo.move.submoves.length > 0) {
			propTwo.move.submoves.pop();
		} else if (parent.parentNode.id === "queue3" && propThree.move.submoves.length > 0) {
			propThree.move.submoves.pop();
		} else if (parent.parentNode.id === "queue4" && propFour.move.submoves.length > 0) {
			propFour.move.submoves.pop();
		}
	}
	predict();
}

function emptyQueues() {
	vs.pause();
	$("#queue1 ul").empty();
	$("#queue2 ul").empty();
	$("#queue3 ul").empty();
	$("#queue4 ul").empty();
	propOne.emptyMoves();
	propTwo.emptyMoves();
	propThree.emptyMoves();
	propFour.emptyMoves();
	totalReset();
}

//**** functionality for JSON export/import
function popExport() {
	totalReset();
	$("#popimport").hide();
	$("#popexport").toggle();
	var str = "{";
	if (propOne.propType !== "noprop") {
		str += ('"prop1": '+ propOne.stringify());
	}
	if (propTwo.propType !== "noprop") {
		str += (', "prop2": '+ propTwo.stringify());
	}
	if (propThree.propType !== "noprop") {
		str += (', "prop3": '+ propThree.stringify());
	}
	if (propFour.propType !== "noprop") {
		str += (', "prop4": '+propFour.stringify());
	}
	str += "}";
	if (str[1] === ",") {
		str = str.replace(", ","");
	}
	$("#popexport textarea").html(str);
}
function popImport() {
	$("#popexport").hide();
	$("#popimport").toggle();
}

var prop1 = "poi";
var prop2 = "poi";
var prop3 = "none";
var prop4 = "none";
var color1 = "blue";
var color2 = "red";
var color3 = "green";
var color4 = "yellow";
function popAlign(n) {
	totalReset();
	$("#popalign"+n).toggle();
	var element;
	var angle;
	element = $('input[name=hand1]').toArray();
	angle = propOne.getHandAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=hand2]').toArray();
	angle = propTwo.getHandAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;;
		}
	}
	element = $('input[name=prop1]').toArray();
	angle = propOne.getPropAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=prop2]').toArray();
	angle = propTwo.getPropAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=pivot1]').toArray();
	angle = propOne.getPivotAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=pivot2]').toArray();
	angle = propTwo.getPivotAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=hand3]').toArray();
	angle = propThree.getHandAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=hand4]').toArray();
	angle = propFour.getHandAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;;
		}
	}
	element = $('input[name=prop3]').toArray();
	angle = propThree.getPropAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=prop4]').toArray();
	angle = propFour.getPropAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=pivot3]').toArray();
	angle = propThree.getPivotAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	element = $('input[name=pivot4]').toArray();
	angle = propFour.getPivotAngle();
	for (var i = 0; i < element.length; i++) {
		if (nearly(parseFloat(element[i].value),angle)) {
			element[i].checked = true;
		} else {
			element[i].checked = false;
		}
	}
	$("#1prop").val(prop1);
	$("#2prop").val(prop2);
	$("#1color").val(color1);
	$("#2color").val(color2);
	$("#3prop").val(prop3);
	$("#4prop").val(prop4);
	$("#3color").val(color3);
	$("#4color").val(color4);
	predict();
	vs.ready();
	redraw();
}

function importSubmit() {
	var imported = $("#popimport textarea").val();
	//okay, here comes the test...
	imported = JSON.parse(imported);
	emptyQueues();
	var parsed;
	if (imported.prop1) {
		propOne.definePosition(VS3D.Constants.parse(imported.prop1));
		vs.ready();
		for (var i = 0; i < imported.prop1.moves.length; i++) {
			parsed = VS3D.Constants.parse(imported.prop1.moves[i]);
			parsed = moves.constructor.prototype.augment(parsed);
			addMoveToQueue(JSON.stringify(parsed), $("#queue1 ul").get(0));
		}
	}
	if (imported.prop2) {
		propTwo.definePosition(VS3D.Constants.parse(imported.prop2));
		vs.ready();
		for (var i = 0; i < imported.prop2.moves.length; i++) {
			parsed = VS3D.Constants.parse(imported.prop2.moves[i]);
			parsed = moves.constructor.prototype.augment(parsed);
			addMoveToQueue(JSON.stringify(parsed), $("#queue2 ul").get(0));
		}
	}
	if (imported.prop3) {
		propThree.definePosition(VS3D.Constants.parse(imported.prop3));
		vs.ready();
		for (var i = 0; i < imported.prop3.moves.length; i++) {
			parsed = VS3D.Constants.parse(imported.prop3.moves[i]);
			parsed = moves.constructor.prototype.augment(parsed);
			addMoveToQueue(JSON.stringify(parsed), $("#queue3 ul").get(0));
		}
	}
	if (imported.prop4) {
		propFour.definePosition(VS3D.Constants.parse(imported.prop4));
		vs.ready();
		for (var i = 0; i < imported.prop4.moves.length; i++) {
			parsed = VS3D.Constants.parse(imported.prop4.moves[i]);
			parsed = moves.constructor.prototype.augment(parsed);
			addMoveToQueue(JSON.stringify(parsed), $("#queue4 ul").get(0));
		}
	}
	vs.ready();
	$("#popimport").toggle();
	predict();
	redraw();
}
function alignSubmit(n) {
	totalReset();
	var prop;
	if (n===1) {
		prop = propOne;
	} else if (n===2) {
		prop = propTwo;
	} else if (n===3) {
		prop = propThree;
	} else if (n===4) {
		prop = propFour;
	}
	prop.setHandAngle(parseFloat($('input[name=hand' + n + ']:checked').val()));
	prop.hand.radius = parseFloat(document.getElementById('hradius'+n).value);
	prop.setPropAngle(parseFloat($('input[name=prop' + n + ']:checked').val()));
	prop.setPivotAngle(parseFloat($('input[name=pivot' + n + ']:checked').val()));
	prop.pivot.radius = parseFloat(document.getElementById('pradius'+n).value);

	var text = document.getElementById(n+"color").value;
	var color;
	var dark;
	if (text === "red") {
		color = "red";
		dark = "64,0,0";
	} else if (text === "blue") {
		color = "blue";
		dark = "0,32,64";
	} else if (text === "yellow") {
		color = "yellow";
		dark = "64,64,0";
	} else if (text === "green") {
		color = "green";
		dark = "0,64,0";
	} else if (text === "orange") {
		color = "orange";
		dark = "64,32,0";
	} else if (text === "white") {
		color = "white";
		dark = "64,64,64";
	}
	text = document.getElementById(n+"prop").value;
	if (n===1) {
		color1 = color;
		prop1 = text;
	} else if (n===2) {
		color2 = color;
		prop2 = text;
	} else if (n===3) {
		color3 = color;
		prop3 = text;
	} else if (n===4) {
		color4 = color;
		prop4 = text;
	}
	if (text=="poi") {
		prop.propType = "poi";
		prop.color = color;
		predictions[n-1].propType = "poi";
		predictions[n-1].color = dark;
	} else if (text=="staff") {
		prop.propType = "staff";
		prop.color = color;
		predictions[n-1].propType = "staff";
		predictions[n-1].color = dark;
	} else if (text=="hoop") {
		prop.propType = "hoop";
		prop.color = color;
		predictions[n-1].propType = "hoop";
		predictions[n-1].color = dark;
	} else if (text=="fan") {
		prop.propType = "fan";
		prop.color = color;
		predictions[n-1].propType = "fan";
		predictions[n-1].color = dark;
	} else if (text=="club") {
		prop.propType = "club";
		prop.color = color;
		predictions[n-1].propType = "fan";
		predictions[n-1].color = dark;
	} else if (text=="buugeng") {
		prop.propType = "buugeng";
		prop.color = color;
		predictions[n-1].propType = "fan";
		predictions[n-1].color = dark;
	} else if (text=="flipbuu") {
		prop.propType = "flipbuu";
		prop.color = color;
		predictions[n-1].propType = "fan";
		predictions[n-1].color = dark;
	} else if (text=="none") {
		prop.propType = "noprop";
		prop.color = color;
		predictions[n-1].propType = "noprop";
		predictions[n-1].color = dark;
	}
	predict();
	vs.ready();
	redraw();
	$("#popalign"+n).toggle();
}

function popSave() {
	$("#popimport").hide();
	$("#popexport").hide();
	$("#popload").hide();
	$("#popsave").toggle();
}
function popLoad() {
	$("#popimport").hide();
	$("#popexport").hide();
	$("#popload").toggle();
	$("#popsave").hide();
}
function saveJSON() {
}

function loadJSON() {
}

</script>
</head>
<body onload="init();">
<header>
	<a href='http://infiniteperplexity.github.io/visual-spinner-3d/'>See more at the VisualSpinner3D main site.</a>
	<h1>Welcome to VisualSpinner3d. </h1>
	<p>Drag moves from the menu to the prop queues, or drag them to the workshop and double-click to modify.</p>
</header>

<div id="content">
	<section>
		<div id="display">
		</div>
		<div id="control">
			<button type="button" onclick="emptyQueues();">Reset Queues</button>
			<button type="button" onclick="popExport();">Export to JSON</button>
			<button type="button" onclick="popImport();">Import from JSON</button>
			<br>
			<button type="button" onclick="popSave();">Save JSON</button>
			<button type="button" onclick="popLoad();">Load JSON</button>
		</div>
		<div id="queues">
			<h2>Props</h2>
			<div id="queue1" class="queue">
				<button type="button" onclick="popAlign(1);">Options</button>
				<ul ondrop="dropQueue(event)" ;="" ondragover="allowDrop(event);"></ul>
			</div>
			<div id="queue2" class="queue">
				<button type="button" onclick="popAlign(2);">Options</button>
				<ul ondrop="dropQueue(event)" ;="" ondragover="allowDrop(event);"></ul>
			</div>
			<div id="queue3" class="queue">
				<button type="button" onclick="popAlign(3);">Options</button>
				<ul ondrop="dropQueue(event)" ;="" ondragover="allowDrop(event);"></ul>
			</div>
			<div id="queue4" class="queue">
				<button type="button" onclick="popAlign(4);">Options</button>
				<ul ondrop="dropQueue(event)" ;="" ondragover="allowDrop(event);"></ul>
			</div>
		</div>


		<div id="workshop" ondrop="dropWorkshop(event);" ondragover="allowDrop(event);">
			<h2>Workshop</h2>
			<ul id="thisMove"></ul>
			<button type="button" onclick='modifyJSON();'>Modify JSON</button>
			<button type="button" onclick="nothing();">Save</button>
		</div>

		<div id="menu">
			<h2>Menu</h2>
			<ul></ul>
		</div>
	</section>
</div>
<div style="display: none;" id="popexport">
	<textarea rows="4" cols="50"></textarea><br>
	<button type="button" onclick="$('#popexport').toggle()">Done</button>
</div>
<div style="display: none;" id="popimport">
	<textarea rows="4" cols="50"></textarea><br>
	<button type="button" onclick="popImport();">Cancel</button>
	<button type="button" onclick="importSubmit();">Submit</button>
</div>
<div style="display: none;" id="popalign1">
		Prop:
			<select id="1prop">
				<option selected="selected" value="poi">Poi</option>
				<option value="staff">Staff</option>
				<option value="hoop">Hoop</option>
				<option value="fan">Fan</option>
				<option value="club">Club</option>
				<option value="buugeng">Buugeng</option>
				<option value="flipbuu">Flipped Buugeng</option>
				<option value="none">None</option>
			</select>
		<br>
		Color:
			<select id="1color">
				<option selected="selected" value="red">Red</option>
				<option value="blue">Blue</option>
				<option value="yellow">Yellow</option>
				<option value="green">Green</option>
				<option value="orange">Orange</option>
				<option value="white">White</option>
			</select>
		<br>
		<br>
		<u>Starting Positions</u>
		<br>
		Hand:
				<p></p><table>
					<tbody><tr>
						<td></td>
						<td><input name="hand1" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="hand1" value="3.141593" type="radio">Left</td>
						<td><input id="hradius1" min="0" max="1" step="0.5" value="1" type="number"></td>
						<td><input name="hand1" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="hand1" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Prop:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="prop1" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="prop1" value="3.141593" type="radio">Left</td>
						<td></td>
						<td><input name="prop1" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="prop1" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Pivot:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="pivot1" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="pivot1" value="3.141593" type="radio">Left</td>
						<td><input id="pradius1" min="0" max="1" step="0.5" value="0" type="number"></td>
						<td><input name="pivot1" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="pivot1" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
	<button type="button" onclick="popAlign(1);">Cancel</button>
	<button type="button" onclick="alignSubmit(1);">Submit</button>
</div>
<div style="display: none;" id="popalign2">
		Prop:
			<select id="2prop">
				<option selected="selected" value="poi">Poi</option>
				<option value="staff">Staff</option>
				<option value="hoop">Hoop</option>
				<option value="fan">Fan</option>
				<option value="club">Club</option>
				<option value="buugeng">Buugeng</option>
				<option value="flipbuu">Flipped Buugeng</option>
				<option value="none">None</option>
			</select>
		<br>
		Color:
			<select id="2color">
				<option selected="selected" value="red">Red</option>
				<option value="blue">Blue</option>
				<option value="yellow">Yellow</option>
				<option value="green">Green</option>
				<option value="orange">Orange</option>
				<option value="white">White</option>
			</select>
		<br>
		<br>
		<u>Starting Positions</u>
		<br>
		Hand:
				<p></p><table>
					<tbody><tr>
						<td></td>
						<td><input name="hand2" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="hand2" value="3.141593" type="radio">Left</td>
						<td><input id="hradius2" min="0" max="1" step="0.5" value="1" type="number"></td>
						<td><input name="hand2" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="hand2" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Prop:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="prop2" value="4.712389" "="" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="prop2" value="3.141593" type="radio">Left</td>
						<td></td>
						<td><input name="prop2" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="prop2" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
			Pivot:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="pivot2" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="pivot2" value="3.141593" type="radio">Left</td>
						<td><input id="pradius2" min="0" max="1" step="0.5" value="0" type="number"></td>
						<td><input name="pivot2" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="pivot2" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
	<button type="button" onclick="popAlign(2);">Cancel</button>
	<button type="button" onclick="alignSubmit(2);">Submit</button>
</div>
<div style="display: none;" id="popalign3">
		Prop:
			<select id="3prop">
				<option value="poi">Poi</option>
				<option value="staff">Staff</option>
				<option value="hoop">Hoop</option>
				<option value="fan">Fan</option>
				<option value="club">Club</option>
				<option value="buugeng">Buugeng</option>
				<option value="flipbuu">Flipped Buugeng</option>
				<option selected="selected" value="none">None</option>
			</select>
		<br>
		Color:
			<select id="3color">
				<option value="red">Red</option>
				<option value="blue">Blue</option>
				<option value="yellow">Yellow</option>
				<option selected="selected" value="green">Green</option>
				<option value="orange">Orange</option>
				<option value="white">White</option>
			</select>
		<br>
		<br>
		<u>Starting Positions</u>
		<br>
		Hand:
				<p></p><table>
					<tbody><tr>
						<td></td>
						<td><input name="hand3" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="hand3" value="3.141593" type="radio">Left</td>
						<td><input id="hradius3" min="0" max="1" step="0.5" value="1" type="number"></td>
						<td><input name="hand3" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="hand3" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Prop:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="prop3" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="prop3" value="3.141593" type="radio">Left</td>
						<td></td>
						<td><input name="prop3" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="prop3" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Pivot:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="pivot3" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="pivot3" value="3.141593" type="radio">Left</td>
						<td><input id="pradius3" min="0" max="1" step="0.5" value="0" type="number"></td>
						<td><input name="pivot3" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="pivot3" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
	<button type="button" onclick="popAlign(3);">Cancel</button>
	<button type="button" onclick="alignSubmit(3);">Submit</button>
</div>
<div style="display: none;" id="popalign4">
		Prop:
			<select id="4prop">
				<option value="poi">Poi</option>
				<option value="staff">Staff</option>
				<option value="hoop">Hoop</option>
				<option value="fan">Fan</option>
				<option value="club">Club</option>
				<option value="buugeng">Buugeng</option>
				<option value="flipbuu">Flipped Buugeng</option>
				<option selected="selected" value="none">None</option>
			</select>
		<br>
		Color:
			<select id="4color">
				<option value="red">Red</option>
				<option value="blue">Blue</option>
				<option selected="selected" value="yellow">Yellow</option>
				<option value="green">Green</option>
				<option value="orange">Orange</option>
				<option value="white">White</option>
			</select>
		<br>
		<br>
		<u>Starting Positions</u>
		<br>
		Hand:
				<p></p><table>
					<tbody><tr>
						<td></td>
						<td><input name="hand4" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="hand4" value="3.141593" type="radio">Left</td>
						<td><input id="hradius4" min="0" max="1" step="0.5" value="1" type="number"></td>
						<td><input name="hand4" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="hand4" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
		Prop:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="prop4" value="4.712389" "="" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="prop4" value="3.141593" type="radio">Left</td>
						<td></td>
						<td><input name="prop4" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="prop4" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
			Pivot:
				<table>
					<tbody><tr>
						<td></td>
						<td><input name="pivot4" value="4.712389" type="radio">Up</td>
						<td></td>
					</tr>
					<tr>
						<td><input checked="checked" name="pivot4" value="3.141593" type="radio">Left</td>
						<td><input id="pradius4" min="0" max="1" step="0.5" value="0" type="number"></td>
						<td><input name="pivot4" value="0" type="radio">Right</td>
					</tr>
					<tr>
						<td></td>
						<td><input name="pivot4" value="1.570796" type="radio">Down</td>
						<td></td>
					</tr>
				</tbody></table>
	<button type="button" onclick="popAlign(4);">Cancel</button>
	<button type="button" onclick="alignSubmit(4);">Submit</button>
</div>
<div style="display: none;" id="moveview">
	<button type="button" onclick='$("#moveview").toggle();'>Okay</button>
	<div id="viewinner"></div>
</div>
<div style="display: none;" id="movemodify">
	<button type="button" onclick='$("#movemodify").toggle();'>Cancel</button>
	<button type="button" onclick="submitChanges();">Submit</button>
	<div id="moveinner"></div>
</div>
<div style="display: none;" id="jsonmodify">
	<button type="button" onclick='$("#jsonmodify").toggle();'>Cancel</button>
	<button type="button" onclick="submitJSON()">Submit</button>
	<br><textarea rows="16" cols="46"></textarea>
</div>
<div style="display: none;" id="popsave">
	<button type="button" onclick='$("#popsave").toggle();'>Cancel</button>
	<button type="button" onclick="saveJSON()">Okay</button>
	<br><textarea rows="1" cols="46">Not currently available.</textarea>
</div>
<div style="display: none;" id="popload">
	<button type="button" onclick='$("#popload").toggle();'>Cancel</button>
	<button type="button" onclick="loadJSON()">Okay</button>
	<br><textarea rows="1" cols="46">Not currently available.</textarea>
</div>

</body></html>
