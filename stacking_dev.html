<!--Distributed under GNU Public License version 3-->
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>VisualSpinner3D: Horizontal Stacking, by Glenn Wright</title>
<style>
	body {background-color: #99CCFF}
	#grid1 {
		width: 450px;
        display: grid;
        grid-column-gap: 3px;
        grid-row-gap: 3px;
        grid-template-rows: 400px auto;
        grid-template-columns: 400px auto;
     }
     #grid2 {
     	width: 450px;
        display: grid;
        grid-template-rows: auto auto auto auto auto auto;
        grid-template-columns: 80px 100px 100px;
     }
</style>
</head>
<script src="scripts/vs3d.js"></script>
<script src="scripts/vs3d-moves.js"></script>
<script src="scripts/three.min.js"></script>
<script src="scripts/vs3d-render.js"></script>
<script src="scripts/vs3d-buugeng.js"></script>
<script>
	let debug = VS3D.debug;
	const {LEFT, RIGHT} = VS3D;
	let renderer, player;
	let defaults = {
		p10: "LL",
		p11: "LR",
		t10: "pendulum",
		t11: "mel",
		p20: "LR",
		p21: "RL",
		t20: "mel",
		t21: "pendulum",
		p30: "RL",
		p31: "RR",
		t30: "mel",
		t31: "pendulum",
		p40: "LR",
		p41: "RL",
		t40: "pendulum",
		t41: "mel"
	};

	// this system is difficult for more complex moves
	let moves = {
		pendulum: {hand: 0, head: -1},
		static: {hand: 0, head: 1},
		mel: {hand: -1, head: -3},
		point: {hand: 1, head: 1},
		charlie: {hand: -1, head: -2},
		ainside: {hand: -1, head: 2},
		extension: {hand: -1, head: -1},
		antispin: {hand: -1, head: 3},
		top: {hand: 1, head: -3},
		isolation: {hand: 2, head: 2} // gets special handling
	};


	let positions = {
		LL: {
			hand: {r: 1, a: LEFT},
			head: {r: 1, a: LEFT}
		},
		LR: {
			hand: {r: 1, a: LEFT},
			head: {r: 1, a: RIGHT}
		},
		CL: {
			hand: {r: 0, a: LEFT},
			head: {r: 1, a: LEFT}
		},
		CR: {
			hand: {r: 0, a: RIGHT},
			head: {r: 1, a: RIGHT}
		},
		RL: {
			hand: {r: 1, a: RIGHT},
			head: {r: 1, a: LEFT}
		},
		RR: {
			hand: {r: 1, a: RIGHT},
			head: {r: 1, a: RIGHT}
		}
	};

	let menus = {
		positions: [
			{txt: "Left, Left", value: "LL"},
			{txt: "Left, Right", value: "LR"},
			{txt: "Center, Left", value: "CL"},
			{txt: "Center, Right", value: "CR"},
			{txt: "Right, Left", value: "RL"},
			{txt: "Right, Right", value: "RR"}
		],
		LL2LL: [
			{txt: "Isolation", value: "isolation"},
			{txt: "Inside Isolation", value: "-isolation"}
		],
		LR2LR: [
			{txt: "Isolation", value: "isolation"},
			{txt: "Inside Isolation", value: "-isolation"}
		],
		LL2LR: [
			{txt: "Pendulum", value: "pendulum"},
			{txt: "Static Spin", value: "static"}
		],
		LL2RL: [
			{txt: "Charlie's Stalls", value: "charlie"},
			{txt: "Inside Antispin", value: "ainside"}
		],
		LL2RR: [
			{txt: "Extension" , value: "extension"},
			{txt: "Antispin" , value: "antispin"},
			{txt: "Top Antispin", value: "top"},
			{txt: "Top Inspin", value: "-antispin"}
		],
		LR2RL: [
			{txt: "Mel's Stalls" , value: "mel"},
			{txt: "Point Isolation", value: "point"}
		],
		LR2RR: [
			{txt: "Charlie's Stalls", value: "charlie"},
			{txt: "Inside Antispin", value: "ainside"}
		],
		RL2RR: [
			{txt: "Pendulum", value: "pendulum"},
			{txt: "Static Spin", value: "static"}
		]
	};

	function init() {
		hideDebugger();
		setupPlayer();
		generalizeMoves();
		setupMenus();
		resolvePositions();
	}

	function hideDebugger() {
		document.getElementById("debugger").style.display = "none";
	}

	// function play() {
	// 	player.play();
	// }

	function setupPlayer() {
		renderer = new VS3D.ThreeRenderer(document.getElementById("display"));
		player = new VS3D.Player();
		player.addProp(new VS3D.Prop({
			hand: {	
				a: positions[defaults.p10].hand.a,
				r: positions[defaults.p10].hand.r
			},
			head: {	
				a: positions[defaults.p10].head.a,
				r: positions[defaults.p10].head.r
			},
		}), {color: "red", nudge: 0.0});
		player.addProp(new VS3D.Prop({
			hand: {	
				a: positions[defaults.p11].hand.a,
				r: positions[defaults.p11].hand.r
			},
			head: {	
				a: positions[defaults.p11].head.a,
				r: positions[defaults.p11].head.r
			},
		}), {color: "white", nudge: 0.05});
		//let controls = new VS3D.Controls(player);
		//renderer.div.appendChild(controls.div);
		player.update = function(pos) {
			renderer.render(this.props, pos);
			//controls.update(this.tick);
		}
		player.ready();
	}

	function generalizeMoves()
	{
		// translations involving center hand position
		let translates;
		translates = {};
		for (let menu in menus)
		{
			if (menu[2]==="2")
			{
				let translate = menu;
				let fun = ()=>{
					if (translate!==menu)
					{
						translates[translate] = [];
						for (let transition of menus[menu])
						{
							let move = {txt: transition.txt, value: transition.value};
							translates[translate].push(move);
						}
					}
				};
				if (menu[0]=="L")
				{
					translate = "C" + translate.substr(1);
					fun();
				}
				if (menu[3]=="L")
				{
					translate = translate.substr(0,3) + "C" + translate.substr(4);
					fun();
				}
				if (menu[0]=="L" && menu[3]=="L")
				{
					translate = "C" + translate.substr(1,2)  + "C" + translate.substr(4);;
					fun();
				}	
			}
		}
		for (let translate in translates)
		{
			menus[translate] = translates[translate];
		}
		// mirror across Left/Right
		let mirrors;
		mirrors = {};
		for (let menu in menus)
		{
			if (menu[2]==="2")
			{
				let mirror;
				mirror = menu.replace(/L/g, "X");
				mirror = mirror.replace(/R/g, "L");
				mirror = mirror.replace(/X/g, "R");
				mirrors[mirror] = [];
				for (let transition of menus[menu])
				{
					let move = {};
					move.txt = transition.txt;
					if (transition.value[0]=="-")
					{
						move.value = transition.value.substr(1);
					}
					else
					{
						move.value = "-"+transition.value;
					}
					mirrors[mirror].push(move);
				}
				
			}
		}
		for (let mirror in mirrors)
		{
			menus[mirror] = mirrors[mirror];
		}
		mirrors = {};
		for (let move in moves)
		{
			let mirror = {hand: {}, head: {}};
			mirror.hand = -moves[move].hand;
			mirror.head = -moves[move].head;
			mirrors[move] = mirror;
		}
		for (let mirror in mirrors)
		{
			moves["-"+mirror] = mirrors[mirror];
		}

	}

	function setupMenus() {
		let menu, option, txt;
		for (let i=1; i<=4; i++) {
			for (let j=0; j<=1; j++) {
				menu = document.getElementById("p"+i+j);
				menu.onchange = resolvePositions;
				for (let position of menus.positions) {
					option = document.createElement("option");
					option.txt = position.txt;
					option.value = position.value;
					if (option.value==defaults["p"+i+j])
					{
						option.selected = true;
					}
					txt = document.createTextNode(position.txt);
					option.appendChild(txt);
					menu.appendChild(option);
				}
			}
		}
	}

	function resolvePositions(e)
	{
		let caller = (e) ? e.target.id : null;
		// set the initial position
		for (let j=0; j<=1; j++) {
			let position = document.getElementById("p1"+j).value;
			let prop = player.props[j];
			let node = positions[position];
			prop.prop.hand.a = node.hand.a;
			prop.prop.hand.r = node.hand.r;
			prop.prop.head.a = node.head.a;
			prop.prop.head.r = node.head.r;
		}
		// rebuild the transition menus
		for (let i=1; i<=4; i++) {
			for (let j=0; j<=1; j++) 
			{
				// update transitions only if an adjacent position was changed
				if (caller===null || (caller[2]==j && (caller[1]==i || (i%4+1)==caller[1]))) {
					let menu = document.getElementById("t"+i+j);
					menu.onchange = resolveTransitions;
					// this should happen only when something really changed
					while (menu.firstChild) {
					    menu.removeChild(menu.firstChild);
					}
					let p0 = document.getElementById("p"+i+j).value;
					let p1 = document.getElementById("p"+(i%4+1)+j).value;
					let endpoints = p0+"2"+p1;
					for (let transition of menus[endpoints])
					{
						option = document.createElement("option");
						option.txt = transition.txt;
						option.value = transition.value;
						txt = document.createTextNode(transition.txt);
						option.appendChild(txt);
						menu.appendChild(option);
					}
				}
				
			}
		}
		resolveTransitions(e);
	}

	function resolveTransitions(e)
	{
		let caller = (e) ? e.target.id : null;
		for (let j=0; j<=1; j++) {
			let prop = player.props[j];
			prop.moves = [];
			for (let i=1; i<=4; i++) {
				let menu = document.getElementById("t"+i+j);
				// choose default if adjacent positions were changed and on page load
				if (caller===null) {
					menu.firstChild.selected = true;
				}
				else if (caller[0]==="p" && caller[2]===j && (caller[1]==i || (i%4+1)==caller[1]))
				{
					menu.firstChild.selected = true;
				}
				let transition = moves[menu.value];
				let p0 = document.getElementById("p"+i+j).value;
				let p1 = document.getElementById("p"+(i%4+1)+j).value;
				let endpoints = p0+"2"+p1;
				// build and add the move
				let move = {
					hand: {va: transition.hand},
					head: {va: transition.head},
					beats: 2
				};
				if (p0[0]=="C" && p1[0]!="C")
				{
					if (p1[0]=="L")
					{
						move.pivot = {};
					}
					else if (p1[0]=="R")
					{
						move.pivot = {};
					}
				}
				else if (p0[0]!="C" && p1[0]=="C")
				{
					if (p0[0]=="L")
					{
						move.pivot = {};
					}
					else if (p0[0]=="R")
					{
						move.pivot = {};
					}
				}
				// right now the isolation is the only pivoted move
				else if (menu.value=="isolation")
				{
					if (endpoints=="LL2LL")
					{
						move.pivot = {r: -1.5, a: LEFT};
					}
					// else if...
				}
				prop.moves.push(move);
			}
			prop.refit();
		}
		player.reset();
		player.play();
	}
	

	function shuffleMenus() {
	}

</script>
<body onload="init();">
<a href="https://github.com/infiniteperplexity/visual-spinner-3d">See more at the VisualSpinner3D main site.</a>
<div id="grid1">
	<div id="display"></div>
	<div>
		<div id="grid2">
			<p>Beat 1:</p>
			<select id="p10"></select>
			<select id="p11"></select>
			<p>Transition:</p>
			<select id="t10"></select>
			<select id="t11"></select>
			<p>Beat 2:</p>
			<select id="p20"></select>
			<select id="p21"></select>
			<p>Transition:</p>
			<select id="t20"></select>
			<select id="t21"></select>
			<p>Beat 3:</p>
			<select id="p30"></select>
			<select id="p31"></select>
			<p>Transition:</p>
			<select id="t30"></select>
			<select id="t31"></select>
			<p>Beat 4:</p>
			<select id="p40"></select>
			<select id="p41"></select>
			<p>Transition:</p>
			<select id="t40"></select>
			<select id="t41"></select>
		</div>
	</div>
	<div>
		<div>
			To do:
			<ul>
				<li>plane-break transitions</li>
				<li>center hand positions</li>
		</div>
		<p>https://github.com/infiniteperplexity/visual-spinner-3d</p>
		<p>infinite DOT perplexity AT gmail DOT com</p>
		<button id="debugger" onclick="shuffleMenus();">debug</button>
	</div>
</div>
</body>
</html>
